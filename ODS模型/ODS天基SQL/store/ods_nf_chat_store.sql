CREATE TABLE v64_deye_dw_ods.ods_nf_chat (
    data_type int,
    user_group string,
    user_name string,
    chat_from string,
    chat_to string,
    strsrc_ip string,
    strdst_ip string,
    src_port int,
    dst_port int,
    ip_type int,
    protocol int,
    dns string,
    net_action string,
    chat_action string,
    dev_id string,
    terminal_type string,
    mac string,
    app_type string,
    app_name string,
    is_webapp int,
    imei string,
    imsi string,
    mcc string,
    mnc string,
    lac string,
    cell_id string,
    phone_number string,
    chat_dir string,
    trace_t string,
    msg string,
    line_id string,
    site string,
    capture_time bigint,
    insert_time bigint,
    data_id string,
    uparea_id int,
    insert_day String,
    insert_hour String,
    insert_min String
) WITH (
    'type' = 'hive',
    'catalog' = 'v64_deye_dw_ods',
    'database' = 'v64_deye_dw_ods',
    'config.directory' = '/usr/hdp/current/hive-client/conf/',
    'version' = '3.1.0',
    'jdbc.url' = '172.16.80.10:10000',
    'security.mode.flag' = 'false',
    'yarn-site.xml' = '/usr/hdp/current/hadoop-client/conf/yarn-site.xml',
    'core-site.xml' = '/usr/hdp/current/hadoop-client/conf/core-site.xml',
    'hdfs-site.xml' = '/usr/hdp/current/hadoop-client/conf/hdfs-site.xml',
    'partitioned' = 'insert_day String,insert_hour String,insert_min String',
    'streaming-source.enable' = 'false',
    'table.exec.hive.infer-source-parallelism.max' = '4'
);

CREATE TABLE v64_deye_dw_ods.ods_nf_chat_store (
    data_type int,
    user_group string,
    user_name string,
    chat_from string,
    chat_to string,
    strsrc_ip string,
    strdst_ip string,
    src_port int,
    dst_port int,
    ip_type int,
    protocol int,
    dns string,
    net_action string,
    chat_action string,
    dev_id string,
    terminal_type string,
    mac string,
    app_type string,
    app_name string,
    is_webapp int,
    imei string,
    imsi string,
    mcc string,
    mnc string,
    lac string,
    cell_id string,
    phone_number string,
    chat_dir string,
    trace_t string,
    msg string,
    line_id string,
    site string,
    capture_time bigint,
    insert_time bigint,
    data_id string,
    uparea_id int,
    capture_day String,
    capture_hour String
) WITH (
    'type' = 'hive',
    'catalog' = 'default',
    'database' = 'v64_deye_dw_ods',
    'config.directory' = '/usr/hdp/current/hive-client/conf/',
    'version' = '3.1.0',
    'createTable' = 'false',
    'jdbc.url' = 'jdbc:hive2://172.16.80.12:10000',
    'yarn-site.xml' = '/usr/hdp/current/hadoop-client/conf/yarn-site.xml',
    'core-site.xml' = '/usr/hdp/current/hadoop-client/conf/core-site.xml',
    'hdfs-site.xml' = '/usr/hdp/current/hadoop-client/conf/hdfs-site.xml',
    'url' = '172.16.80.12:10000',
    'security.mode.flag' = 'false',
    'partitioned' = 'capture_day String,capture_hour String',
    'sink.partition-commit.delay' = '1 min',
    'sink.partition-commit.policy.kind' = 'metastore,success-file',
    'partition.time-extractor.timestamp-pattern' = '$capture_day $capture_hour:00:00'
);

INSERT INTO
    v64_deye_dw_ods.ods_nf_chat_store
SELECT
    data_type,
    user_group,
    user_name,
    chat_from,
    chat_to,
    strsrc_ip,
    strdst_ip,
    src_port,
    dst_port,
    ip_type,
    protocol,
    dns,
    net_action,
    chat_action,
    dev_id,
    terminal_type,
    mac,
    app_type,
    app_name,
    is_webapp,
    imei,
    imsi,
    mcc,
    mnc,
    lac,
    cell_id,
    phone_number,
    chat_dir,
    trace_t,
    msg,
    line_id,
    site,
    capture_time,
    unix_timestamp()*1000 as insert_time,
    data_id,
    uparea_id,
    from_unixtime(capture_time/1000, 'yyyy-MM-dd') as capture_day,
    from_unixtime(capture_time/1000, 'HH') as capture_hour
FROM
    v64_deye_dw_ods.ods_nf_chat
WHERE
    insert_day = from_unixtime(unix_timestamp()-24*3600, 'yyyy-MM-dd');
