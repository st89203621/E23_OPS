CREATE SCALAR FUNCTION deyeTimestampConverter WITH com.semptian.udf.timestamphandle.DeyeTimestampConverter;


CREATE TABLE ods_pr_contactlog (
    stream_end_time long,
    session_id string,
    capture_time long,
    M040007 string,
    A080001 string,
    host string,
    T005206 string,
    rule_version string,
    M020039 string,
    M020038 string,
    zipFilePath string,
    A010019 string,
    T006817 string,
    device_id string,
    N020014 string,
    N020013 string,
    proxy_account string,
    base_station_id string,
    A010005 string,
    protocol_type string,
    data_type string,
    favorite_tags string,
    J050004 string,
    associate_mobile string,
    J050003 string,
    child_type string,
    record_id string,
    imei string,
    A010006 string,
    A010007 string,
    N020004 string,
    hardware_sign string,
    mac string,
    T007130 string,
    hardware_type string,
    I030020 string,
    down_teid string,
    I030021 string,
    up_teid string,
    abstract string,
    A010037 string,
    ownership_land string,
    internet_land string,
    M030020 string,
    proxy_provider string,
    A010034 string,
    proxy_type string,
    proxy_address string,
    soft_name string,
    T007129 string,
    dst_ip_area string,
    src_ip_area string,
    dst_port_v6 int,
    auth_type string,
    src_port_v6 int,
    auth_account string,
    strdst_ip_v6 string,
    strsrc_ip_v6 string,
    tunnel_type string,
    I010001 string,
    icp_provider string,
    local_action string,
    host_url_tag string,
    application_layer_protocol string,
    M030024 string,
    up_traffic double,
    down_traffic double,
    A010024 string,
    A010025 string,
    I030004 string,
    I030005 string,
    M010009 string,
    T007117 string,
    trace_id string,
    uparea_id string,
    file_size int,
    dst_port int,
    T006703 string,
    isp_id string,
    src_port int,
    strdst_ip string,
    strsrc_ip string,
    B010010 string,
    file_md5 string,
    M020001 string,
    J140002 string,
    M020041 string,
    imsi string,
    M020040 string,
    I030001 string,
    I030002 string,
    longitude double
)WITH (
    'type' = 'kafka',
    'topic' = 'ods_pr_source_my0707_contactlog',
    'bootstrap.servers' = 'hdp-01:6667,hdp-02:6667,hdp-03:6667,hdp-04:6667,hdp-07:6667,hdp-05:6667,hdp-06:6667,hdp-08:6667',
    'zookeeper.connect' = 'hdp-01:2181,hdp-02:2181,hdp-03:2181,hdp-04:2181,hdp-07:2181,hdp-05:2181,hdp-06:2181',
    'security.mode.flag' = 'false',
    'group.id' = 'ods_pr_contactlog_store',
    'enable.auto.commit' = 'false',
    'auto.commit.interval.ms' = '6000',
    'auto.offset.reset' = 'latest',
    'session.timeout.ms' = '30000',
    'format.type' = 'avro',
    'feature.max.poll.records' = '1000',
	'feature.fetch.max.bytes' = '11534336',
	'feature.max.partition.fetch.bytes' = '11534336',
	'feature.fetch.message.max.bytes' = '11534336',
    'feature.request.timeout.ms' = '120000',
    'parallelism' = '8'
    );


CREATE TABLE v64_deye_dw_ods.ods_pr_contactlog_store (
    stream_end_time long,
    session_id string,
    capture_time long,
    M040007 string,
    A080001 string,
    host string,
    T005206 string,
    rule_version string,
    M020039 string,
    M020038 string,
    zipFilePath string,
    A010019 string,
    T006817 string,
    device_id string,
    N020014 string,
    N020013 string,
    proxy_account string,
    base_station_id string,
    A010005 string,
    protocol_type string,
    data_type string,
    favorite_tags string,
    J050004 string,
    associate_mobile string,
    J050003 string,
    child_type string,
    record_id string,
    imei string,
    A010006 string,
    A010007 string,
    N020004 string,
    hardware_sign string,
    mac string,
    T007130 string,
    hardware_type string,
    I030020 string,
    down_teid string,
    I030021 string,
    up_teid string,
    abstract string,
    A010037 string,
    ownership_land string,
    internet_land string,
    M030020 string,
    proxy_provider string,
    A010034 string,
    proxy_type string,
    proxy_address string,
    soft_name string,
    T007129 string,
    dst_ip_area string,
    src_ip_area string,
    dst_port_v6 int,
    auth_type string,
    src_port_v6 int,
    auth_account string,
    strdst_ip_v6 string,
    strsrc_ip_v6 string,
    tunnel_type string,
    I010001 string,
    icp_provider string,
    local_action string,
    host_url_tag string,
    application_layer_protocol string,
    M030024 string,
    up_traffic double,
    down_traffic double,
    A010024 string,
    A010025 string,
    I030004 string,
    I030005 string,
    M010009 string,
    T007117 string,
    trace_id string,
    uparea_id string,
    file_size int,
    dst_port int,
    T006703 string,
    isp_id string,
    src_port int,
    strdst_ip string,
    strsrc_ip string,
    B010010 string,
    file_md5 string,
    M020001 string,
    J140002 string,
    M020041 string,
    imsi string,
    M020040 string,
    I030001 string,
    I030002 string,
    longitude double,
    capture_day String,
    capture_hour String
)WITH (
    'type' = 'hive',
    'catalog' = 'default',
    'database' = 'v64_deye_dw_ods',
    'config.directory' = '/usr/hdp/current/hive-client/conf/',
    'version' = '3.1.0',
    'createTable' = 'false',
    'jdbc.url' = 'jdbc:hive2://172.16.80.12:10000',
    'yarn-site.xml' = '/usr/hdp/current/hadoop-client/conf/yarn-site.xml',
    'core-site.xml' = '/usr/hdp/current/hadoop-client/conf/core-site.xml',
    'hdfs-site.xml' = '/usr/hdp/current/hadoop-client/conf/hdfs-site.xml',
    'url' = '172.16.80.12:10000',
    'security.mode.flag' = 'false',
    'partitioned' = 'capture_day String,capture_hour String',
    'sink.partition-commit.delay' = '1 min',
    'sink.partition-commit.policy.kind' = 'metastore,success-file',
    'partition.time-extractor.timestamp-pattern' = '$capture_day $capture_hour:00:00'
    );


INSERT INTO
 v64_deye_dw_ods.ods_pr_contactlog_store
SELECT
    stream_end_time,
    session_id,
    capture_time,
    M040007,
    A080001,
    host,
    T005206,
    rule_version,
    M020039,
    M020038,
    zipFilePath,
    A010019,
    T006817,
    device_id,
    N020014,
    N020013,
    proxy_account,
    base_station_id,
    A010005,
    protocol_type,
    data_type,
    favorite_tags,
    J050004,
    associate_mobile,
    J050003,
    child_type,
    record_id,
    imei,
    A010006,
    A010007,
    N020004,
    hardware_sign,
    mac,
    T007130,
    hardware_type,
    I030020,
    down_teid,
    I030021,
    up_teid,
    abstract,
    A010037,
    ownership_land,
    internet_land,
    M030020,
    proxy_provider,
    A010034,
    proxy_type,
    proxy_address,
    soft_name,
    T007129,
    dst_ip_area,
    src_ip_area,
    dst_port_v6,
    auth_type,
    src_port_v6,
    auth_account,
    strdst_ip_v6,
    strsrc_ip_v6,
    tunnel_type,
    I010001,
    icp_provider,
    local_action,
    host_url_tag,
    application_layer_protocol,
    M030024,
    up_traffic,
    down_traffic,
    A010024,
    A010025,
    I030004,
    I030005,
    M010009,
    T007117,
    trace_id,
    uparea_id,
    file_size,
    dst_port,
    T006703,
    isp_id,
    src_port,
    strdst_ip,
    strsrc_ip,
    B010010,
    file_md5,
    M020001,
    J140002,
    M020041,
    imsi,
    M020040,
    I030001,
    I030002,
    longitude,
    deyeTimestampConverter(capture_time,'yyyy-MM-dd') as capture_day,
    deyeTimestampConverter(capture_time,'HH') as capture_hour
FROM
    ods_pr_contactlog;