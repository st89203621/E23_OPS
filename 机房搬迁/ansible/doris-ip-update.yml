---
# Dorisé›†ç¾¤IPè¿ç§»è„šæœ¬ (ä¿®å¤ç‰ˆ)
# ä½¿ç”¨æ–¹æ³•:
# é˜¶æ®µ1 - FQDNæ”¹é€ : ansible-playbook -i inventory/doris_old.ini doris-ip-update.yml --tags "fqdn_setup"
# é˜¶æ®µ2 - IPè¿ç§»: ansible-playbook -i inventory/doris_new.ini doris-ip-update.yml --tags "ip_migration" --extra-vars "new_network=192.168.28"

# å…¨å±€å˜é‡å’Œå‰ç½®æ£€æŸ¥
- name: "è®¾ç½®å…¨å±€å˜é‡å’Œå‰ç½®æ£€æŸ¥"
  hosts: localhost
  gather_facts: yes
  tags: ["always"]
  vars:
    doris_home: "/home/semptian/apache-doris-2.1.6-bin-x64"
    mysql_conn: "-h 192.168.15.62 -P 9030 -u root -p123456"
    fe_follower_nodes: ["doris-s1", "doris-s3", "doris-s11", "doris-s20"]
    master_node: "doris-s12"
  tasks:
    - name: è®¾ç½®å…¨å±€å˜é‡
      set_fact:
        doris_home: "{{ doris_home }}"
        mysql_conn: "{{ mysql_conn }}"
        backup_suffix: "{{ ansible_date_time.epoch }}"
        timestamp: "{{ ansible_date_time.epoch }}"
        
    - name: å‰ç½®æ¡ä»¶æ£€æŸ¥æé†’
      debug:
        msg: |
          âš ï¸  æ‰§è¡Œå‰å¿…é¡»ç¡®è®¤ï¼š
          1. ä¸Šæ¸¸å·²åœæ­¢æ•°æ®å†™å…¥å’ŒæŸ¥è¯¢
          2. å·²å…³é—­Doris Managerè‡ªåŠ¨æ‹‰èµ·åŠŸèƒ½
          3. å·²åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ­¤è„šæœ¬
          4. å·²å‡†å¤‡å›æ»šæ–¹æ¡ˆ
      
    - name: ç­‰å¾…ç¡®è®¤
      pause:
        prompt: "è¯·ç¡®è®¤ä¸Šè¿°å‰ç½®æ¡ä»¶å·²æ»¡è¶³ï¼ŒæŒ‰Enterç»§ç»­æˆ–Ctrl+Cä¸­æ­¢"
      when: ansible_run_tags is not defined or 'skip_confirm' not in ansible_run_tags

# æ£€æŸ¥æ§åˆ¶èŠ‚ç‚¹MySQLå®¢æˆ·ç«¯
- name: "æ£€æŸ¥æ§åˆ¶èŠ‚ç‚¹MySQLå®¢æˆ·ç«¯"
  hosts: localhost
  gather_facts: no
  tags: ["fqdn_setup", "ip_migration", "mysql_check"]
  tasks:
    - name: æ£€æŸ¥æœ¬åœ°MySQLå®¢æˆ·ç«¯
      shell: command -v mysql
      register: mysql_check
      failed_when: false
      ignore_errors: yes

    - name: æ˜¾ç¤ºMySQLå®¢æˆ·ç«¯çŠ¶æ€
      debug:
        msg: "æ§åˆ¶èŠ‚ç‚¹MySQLå®¢æˆ·ç«¯: {{ 'OK' if mysql_check.rc == 0 else 'NOT FOUND' }}"

    - name: MySQLå®¢æˆ·ç«¯ç¼ºå¤±å¤„ç†
      fail:
        msg: |
          âŒ æ§åˆ¶èŠ‚ç‚¹ç¼ºå°‘MySQLå®¢æˆ·ç«¯ï¼
          è¯·å®‰è£…MySQLå®¢æˆ·ç«¯ï¼š
          Ubuntu/Debian: sudo apt install mysql-client
          CentOS/RHEL: sudo yum install mysql
          æˆ–è€…è·³è¿‡æ­¤æ£€æŸ¥: --skip-tags "mysql_check"
      when: mysql_check.rc != 0

# é˜¶æ®µ1: FQDNæ”¹é€ 
- name: "é˜¶æ®µ1: è®°å½•é›†ç¾¤åˆå§‹çŠ¶æ€"
  hosts: localhost
  gather_facts: no
  tags: ["fqdn_setup"]
  tasks:
    - name: è®°å½•FEå’ŒBEçŠ¶æ€
      shell: |
        mysql {{ mysql_conn }} -e "
        SHOW FRONTENDS;
        SHOW BACKENDS;" > /tmp/doris_cluster_status_before_fqdn_{{ hostvars['localhost']['backup_suffix'] }}.log 2>/dev/null || echo "MySQLè¿æ¥å¤±è´¥ï¼Œè·³è¿‡çŠ¶æ€è®°å½•"
      ignore_errors: yes

- name: "é˜¶æ®µ1: å…³é—­åˆ†ç‰‡å‡è¡¡"
  hosts: localhost
  gather_facts: no
  tags: ["fqdn_setup"]
  tasks:
    - name: å…³é—­åˆ†ç‰‡å‡è¡¡åŠŸèƒ½
      shell: |
        mysql {{ mysql_conn }} -e "
        admin set frontend config('disable_balance' = 'true');
        admin set frontend config('disable_colocate_balance' = 'true');
        admin set frontend config('disable_tablet_scheduler' = 'true');" 2>/dev/null || echo "MySQLè¿æ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…³é—­åˆ†ç‰‡å‡è¡¡"
      ignore_errors: yes

- name: "é˜¶æ®µ1: å‡†å¤‡å·¥ä½œ"
  hosts: doris_cluster
  gather_facts: yes
  tags: ["fqdn_setup"]
  tasks:
    - name: æ£€æŸ¥å¹¶å¼ºåˆ¶åœæ­¢è‡ªå¯åŠ¨æœåŠ¡
      shell: |
        for service in doris-be.service doris-fe.service; do
          if systemctl list-unit-files | grep -q "^$service"; then
            echo "åœæ­¢å¹¶ç¦ç”¨æœåŠ¡: $service"
            systemctl stop $service 2>/dev/null || true
            systemctl disable $service 2>/dev/null || true
            systemctl mask $service 2>/dev/null || true
            echo "æœåŠ¡ $service å·²åœæ­¢ã€ç¦ç”¨å¹¶å±è”½"
          else
            echo "æœåŠ¡ä¸å­˜åœ¨ï¼Œè·³è¿‡: $service"
          fi
        done

        # é¢å¤–æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹ç®¡ç†å·¥å…·
        echo "æ£€æŸ¥å¯èƒ½çš„è¿›ç¨‹ç®¡ç†å·¥å…·..."
        ps aux | grep -E "(supervisor|systemd|doris)" | grep -v grep || echo "æœªå‘ç°ç›¸å…³è¿›ç¨‹ç®¡ç†å·¥å…·"
      ignore_errors: yes

    - name: åœæ­¢ç®¡ç†æœåŠ¡å’Œè‡ªåŠ¨æ‹‰èµ·æœºåˆ¶
      shell: |
        # åœæ­¢Doris Manager (å¦‚æœæ˜¯s2èŠ‚ç‚¹)
        {% if inventory_hostname == "doris-s2" %}
        cd /home/semptian/doris-manager/webserver/bin && ./stop 2>/dev/null || true
        {% endif %}

        # åœæ­¢Manager Agent
        cd /home/semptian/manager-agent/bin && ./stop.sh 2>/dev/null || true

        # æ£€æŸ¥å¹¶åœæ­¢å¯èƒ½çš„å®šæ—¶ä»»åŠ¡æˆ–ç›‘æ§è„šæœ¬
        crontab -l 2>/dev/null | grep -i doris || echo "æœªå‘ç°dorisç›¸å…³å®šæ—¶ä»»åŠ¡"

        # æ£€æŸ¥systemd timer
        systemctl list-timers | grep -i doris || echo "æœªå‘ç°dorisç›¸å…³å®šæ—¶å™¨"

        # åœæ­¢å¯èƒ½çš„supervisorè¿›ç¨‹
        supervisorctl stop all 2>/dev/null || echo "supervisoræœªè¿è¡Œæˆ–ä¸å­˜åœ¨"

        echo "ç®¡ç†æœåŠ¡åœæ­¢å®Œæˆ"
      ignore_errors: yes

- name: "é˜¶æ®µ1: æ›´æ–°hostsæ–‡ä»¶"
  hosts: doris_cluster
  gather_facts: no
  tags: ["fqdn_setup", "ip_migration"]
  tasks:
    - name: å¤‡ä»½hostsæ–‡ä»¶
      copy:
        src: /etc/hosts
        dest: "/etc/hosts.backup.{{ hostvars['localhost']['backup_suffix'] }}"
        remote_src: yes

    - name: å½»åº•æ¸…ç†æ—§çš„Doris hostsé…ç½®
      shell: |
        # å¤‡ä»½å½“å‰hostsæ–‡ä»¶
        cp /etc/hosts /etc/hosts.pre-clean.{{ hostvars['localhost']['backup_suffix'] }}

        # åˆ é™¤æ‰€æœ‰åŒ…å«doris-sçš„è¡Œï¼ˆæ— è®ºIPæ®µï¼‰
        sed -i '/doris-s[0-9]\+/d' /etc/hosts

        # åˆ é™¤DORIS CLUSTERæ ‡è®°å—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        sed -i '/# BEGIN DORIS CLUSTER/,/# END DORIS CLUSTER/d' /etc/hosts

        # åˆ é™¤å¯èƒ½çš„ç©ºè¡Œ
        sed -i '/^$/N;/^\n$/d' /etc/hosts

        echo "æ¸…ç†å®Œæˆï¼Œå·²åˆ é™¤æ‰€æœ‰doris-sç›¸å…³æ¡ç›®"

    - name: ç”Ÿæˆhostsæ˜ å°„å†…å®¹
      set_fact:
        hosts_content: |
          {% if 'ip_migration' in ansible_run_tags %}
          {% for i in range(1, 34) %}
          192.168.28.{{ 100 + i }} doris-s{{ i }}
          {% endfor %}
          {% else %}
          {% for i in range(1, 34) %}
          192.168.15.{{ 50 + i }} doris-s{{ i }}
          {% endfor %}
          {% endif %}

    - name: æ›´æ–°hostsæ–‡ä»¶
      blockinfile:
        path: /etc/hosts
        marker: "# {mark} DORIS CLUSTER HOSTS"
        block: "{{ hosts_content }}"

# é˜¶æ®µ1: Follower FEèŠ‚ç‚¹FQDNæ”¹é€  (ä¸¥æ ¼æŒ‰ç…§æ–‡æ¡£é¡ºåº)
- name: "é˜¶æ®µ1: Follower FEèŠ‚ç‚¹FQDNæ”¹é€ "
  hosts: doris-s1,doris-s3,doris-s11,doris-s20
  gather_facts: no
  serial: 1  # é€ä¸ªæ‰§è¡Œ
  tags: ["fqdn_setup"]
  tasks:
    - name: å¤‡ä»½FEæ•°æ®å’Œé…ç½®
      shell: |
        cd {{ hostvars['localhost']['doris_home'] }}/fe
        cp -r doris-meta doris-meta-bak{{ hostvars['localhost']['backup_suffix'] }}
        cp conf/fe.conf conf/fe.conf-bak{{ hostvars['localhost']['backup_suffix'] }}

    - name: 1. å¼ºåˆ¶åœæ­¢FEèŠ‚ç‚¹
      shell: |
        cd {{ hostvars['localhost']['doris_home'] }}/fe/bin
        ./stop_fe.sh

        # ç­‰å¾…å‡ ç§’é’Ÿ
        sleep 3

        # å¼ºåˆ¶æ€æ­»å¯èƒ½æ®‹ç•™çš„è¿›ç¨‹
        pkill -f "DorisFE" || true
        pkill -f "fe.conf" || true

        # å†æ¬¡ç¡®è®¤åœæ­¢systemdæœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        systemctl stop doris-fe.service 2>/dev/null || true
        systemctl mask doris-fe.service 2>/dev/null || true

        echo "FEèŠ‚ç‚¹åœæ­¢å®Œæˆ"

    - name: 1.5. æœ¬åœ°éªŒè¯FEè¿›ç¨‹å·²åœæ­¢
      shell: |
        # æ£€æŸ¥FEè¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
        fe_processes=$(ps aux | grep -E "(DorisFE|fe\.conf)" | grep -v grep | wc -l)
        echo "å½“å‰FEè¿›ç¨‹æ•°é‡: $fe_processes"

        if [ $fe_processes -gt 0 ]; then
          echo "è­¦å‘Š: ä»æœ‰FEè¿›ç¨‹åœ¨è¿è¡Œï¼Œå°è¯•å¼ºåˆ¶ç»ˆæ­¢..."
          pkill -9 -f "DorisFE" || true
          pkill -9 -f "fe.conf" || true
          sleep 2
          fe_processes=$(ps aux | grep -E "(DorisFE|fe\.conf)" | grep -v grep | wc -l)
          echo "å¼ºåˆ¶ç»ˆæ­¢åFEè¿›ç¨‹æ•°é‡: $fe_processes"
        fi

        # æ£€æŸ¥ç«¯å£æ˜¯å¦è¿˜åœ¨ç›‘å¬
        netstat -tlnp 2>/dev/null | grep ":9030" || echo "ç«¯å£9030æœªåœ¨ç›‘å¬"
        netstat -tlnp 2>/dev/null | grep ":9010" || echo "ç«¯å£9010æœªåœ¨ç›‘å¬"

    - name: 2. éªŒè¯èŠ‚ç‚¹å·²åœæ­¢ (æ£€æŸ¥AliveçŠ¶æ€å˜ä¸ºfalse)
      shell: |
        mysql {{ hostvars['localhost']['mysql_conn'] }} -e "SHOW FRONTENDS;" | grep {{ inventory_hostname }} | grep false
      register: fe_stopped
      retries: 12
      delay: 5
      until: fe_stopped.rc == 0
      delegate_to: localhost

    - name: 3. è®¾ç½®FQDN
      shell: |
        mysql {{ hostvars['localhost']['mysql_conn'] }} -e "
        ALTER SYSTEM MODIFY FRONTEND '{{ ansible_default_ipv4.address }}:9010' HOSTNAME '{{ inventory_hostname }}';"
      register: fqdn_result
      delegate_to: localhost

    - name: 4. ä¿®æ”¹èŠ‚ç‚¹é…ç½®å¯ç”¨FQDNæ¨¡å¼
      lineinfile:
        path: "{{ hostvars['localhost']['doris_home'] }}/fe/conf/fe.conf"
        line: "enable_fqdn_mode = true"
        backup: yes

    - name: 5. å¯åŠ¨FEèŠ‚ç‚¹
      shell: |
        cd {{ hostvars['localhost']['doris_home'] }}/fe/bin
        ./start_fe.sh --helper doris-s12:9010 --daemon

    - name: ç­‰å¾…FEèŠ‚ç‚¹å¯åŠ¨
      wait_for:
        port: 9030
        timeout: 120

    - name: éªŒè¯èŠ‚ç‚¹çŠ¶æ€
      shell: |
        mysql {{ hostvars['localhost']['mysql_conn'] }} -e "SHOW FRONTENDS;" | grep {{ inventory_hostname }}
      register: fe_status
      retries: 5
      delay: 10
      delegate_to: localhost

    - name: æ˜¾ç¤ºèŠ‚ç‚¹çŠ¶æ€
      debug:
        msg: "{{ inventory_hostname }} çŠ¶æ€: {{ fe_status.stdout }}"

    - name: ç­‰å¾…èŠ‚ç‚¹ç¨³å®š
      pause:
        seconds: 30

# é˜¶æ®µ1: MasterèŠ‚ç‚¹FQDNæ”¹é€ 
- name: "é˜¶æ®µ1: MasterèŠ‚ç‚¹FQDNæ”¹é€ "
  hosts: doris-s12
  gather_facts: no
  tags: ["fqdn_setup"]
  tasks:
    - name: å¤‡ä»½Master FEæ•°æ®
      shell: |
        cd {{ hostvars['localhost']['doris_home'] }}/fe
        cp -r doris-meta doris-meta-bak{{ hostvars['localhost']['backup_suffix'] }}-master
        cp conf/fe.conf conf/fe.conf-bak{{ hostvars['localhost']['backup_suffix'] }}-master

    - name: ä¿®æ”¹Masteré…ç½®å¯ç”¨FQDNæ¨¡å¼
      lineinfile:
        path: "{{ hostvars['localhost']['doris_home'] }}/fe/conf/fe.conf"
        line: "enable_fqdn_mode = true"
        backup: yes

    - name: åœæ­¢MasterèŠ‚ç‚¹ (è§¦å‘é‡æ–°é€‰ä¸»)
      shell: |
        cd {{ hostvars['localhost']['doris_home'] }}/fe/bin
        ./stop_fe.sh

    - name: ç­‰å¾…Masteré€‰ä¸¾å®Œæˆ
      pause:
        seconds: 30

- name: "é˜¶æ®µ1: å®ŒæˆMaster FQDNè®¾ç½®"
  hosts: localhost
  gather_facts: no
  tags: ["fqdn_setup"]
  tasks:
    - name: æ£€æµ‹æ–°Masterå¹¶è®¾ç½®åŸMaster FQDN
      shell: |
        # æ‰¾åˆ°æ–°Master
        for ip in 192.168.15.51 192.168.15.53 192.168.15.61 192.168.15.70; do
          new_master=$(mysql -h $ip -P 9030 -u root -p123456 -e "SHOW FRONTENDS;" 2>/dev/null | grep -E "true.*MASTER" | awk '{print $2}')
          if [ ! -z "$new_master" ]; then
            # è®¾ç½®åŸMaster FQDN
            mysql -h $ip -P 9030 -u root -p123456 -e "ALTER SYSTEM MODIFY FRONTEND '192.168.15.62:9010' HOSTNAME 'doris-s12';"
            echo $ip
            break
          fi
        done
      register: new_master_result

    - name: å¯åŠ¨åŸMasterèŠ‚ç‚¹
      shell: |
        ssh doris-s12 "cd {{ doris_home }}/fe/bin && ./start_fe.sh --helper {{ new_master_result.stdout }}:9010 --daemon"
      when: new_master_result.stdout != ""

    - name: è®¾ç½®BEèŠ‚ç‚¹FQDN
      shell: |
        mysql {{ mysql_conn }} -e "
        ALTER SYSTEM MODIFY BACKEND '192.168.15.{{ item }}:9050' HOSTNAME 'doris-s{{ item - 50 }}';"
      loop: "{{ range(51, 84) | list }}"
      throttle: 3
      ignore_errors: yes

    - name: éªŒè¯FQDNæ”¹é€ ç»“æœ
      shell: |
        mysql {{ mysql_conn }} -e "
        SHOW FRONTENDS;
        SHOW BACKENDS;" > /tmp/doris_cluster_status_after_fqdn_{{ hostvars['localhost']['backup_suffix'] }}.log

    - name: æ˜¾ç¤ºFQDNæ”¹é€ å®Œæˆä¿¡æ¯
      debug:
        msg: |
          ========================================
          FQDNæ”¹é€ å®Œæˆï¼
          çŠ¶æ€å·²ä¿å­˜åˆ°: /tmp/doris_cluster_status_after_fqdn_{{ hostvars['localhost']['backup_suffix'] }}.log
          ç°åœ¨å¯ä»¥æ‰§è¡ŒIPè¿ç§»ï¼š
          ansible-playbook -i inventory/doris_new.ini doris-ip-update-fixed.yml --tags "ip_migration" --extra-vars "new_network=192.168.28"
          ========================================

# é˜¶æ®µ2: IPè¿ç§»
- name: "é˜¶æ®µ2: éªŒè¯å‚æ•°å’Œè®°å½•çŠ¶æ€"
  hosts: localhost
  gather_facts: yes
  tags: ["ip_migration"]
  tasks:
    - name: æ£€æŸ¥new_networkå‚æ•°
      fail:
        msg: "è¯·æä¾›new_networkå‚æ•°: --extra-vars 'new_network=192.168.28'"
      when: new_network is not defined

    - name: è®°å½•è¿ç§»å‰é›†ç¾¤çŠ¶æ€
      shell: |
        mysql -h 192.168.15.62 -P 9030 -u root -p123456 -e "
        SHOW FRONTENDS;
        SHOW BACKENDS;
        SHOW PROC '/backends';" > /tmp/doris_cluster_status_before_migration_{{ hostvars['localhost']['timestamp'] }}.log
      ignore_errors: yes

- name: "é˜¶æ®µ2: åœæ­¢æ‰€æœ‰DorisæœåŠ¡"
  hosts: doris_cluster
  gather_facts: no
  tags: ["ip_migration"]
  tasks:
    - name: åœæ­¢BEæœåŠ¡ (å…ˆåœBE)
      shell: |
        cd {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/be/bin
        ./stop_be.sh
      ignore_errors: yes
      when: inventory_hostname not in ['doris-s1', 'doris-s3', 'doris-s11', 'doris-s12', 'doris-s20'] or inventory_hostname in ['doris-s1', 'doris-s3', 'doris-s11', 'doris-s12', 'doris-s20']

    - name: ç­‰å¾…BEæœåŠ¡åœæ­¢
      wait_for:
        port: 9060
        state: stopped
        timeout: 60
      ignore_errors: yes

- name: "é˜¶æ®µ2: åœæ­¢FEæœåŠ¡ (å…ˆFolloweråMaster)"
  hosts: doris-s1,doris-s3,doris-s11,doris-s20
  gather_facts: no
  serial: 1
  tags: ["ip_migration"]
  tasks:
    - name: åœæ­¢Follower FEæœåŠ¡
      shell: |
        cd {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/fe/bin
        ./stop_fe.sh
      ignore_errors: yes

    - name: ç­‰å¾…FEæœåŠ¡åœæ­¢
      wait_for:
        port: 9030
        state: stopped
        timeout: 60
      ignore_errors: yes

- name: "é˜¶æ®µ2: åœæ­¢Master FEæœåŠ¡"
  hosts: doris-s12
  gather_facts: yes
  tags: ["ip_migration"]
  tasks:
    - name: åœæ­¢Master FEæœåŠ¡
      shell: |
        cd {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/fe/bin
        ./stop_fe.sh
      ignore_errors: yes

    - name: ç­‰å¾…Master FEæœåŠ¡åœæ­¢
      wait_for:
        port: 9030
        state: stopped
        timeout: 60
      ignore_errors: yes

    - name: æœ€ç»ˆå¤‡ä»½Masterå…ƒæ•°æ®
      shell: |
        cd {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/fe
        cp -r doris-meta doris-meta-bak{{ hostvars['localhost']['timestamp'] }}-final
        cp conf/fe.conf conf/fe.conf-bak{{ hostvars['localhost']['timestamp'] }}-final

    - name: ç¡®è®¤æ‰€æœ‰Dorisè¿›ç¨‹å·²åœæ­¢
      shell: ps -ef | grep doris | grep -v grep
      register: doris_processes
      ignore_errors: yes

    - name: æ˜¾ç¤ºå‰©ä½™è¿›ç¨‹
      debug:
        var: doris_processes.stdout_lines
      when: doris_processes.stdout_lines | length > 0

- name: "é˜¶æ®µ2: åœæ­¢ç®¡ç†æœåŠ¡"
  hosts: doris_cluster
  gather_facts: no
  tags: ["ip_migration"]
  tasks:
    - name: åœæ­¢Managerå’ŒAgentæœåŠ¡
      shell: |
        {% if inventory_hostname == "doris-s2" %}
        cd /home/semptian/doris-manager/webserver/bin && ./stop 2>/dev/null || true
        {% endif %}
        cd /home/semptian/manager-agent/bin && ./stop.sh 2>/dev/null || true
      ignore_errors: yes

- name: "é˜¶æ®µ2: æ›´æ–°é…ç½®æ–‡ä»¶"
  hosts: doris_cluster
  gather_facts: no
  tags: ["ip_migration"]
  tasks:
    - name: æ›´æ–°FEé…ç½®æ–‡ä»¶ - priority_networks (ä¿®æ­£ä¸º22ä½æ©ç )
      lineinfile:
        path: "{{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/fe/conf/fe.conf"
        regexp: '^priority_networks\s*='
        line: "priority_networks = {{ new_network }}.0/22"
        backup: yes
      when: inventory_hostname in ['doris-s1', 'doris-s3', 'doris-s11', 'doris-s12', 'doris-s20']

    - name: æ›´æ–°BEé…ç½®æ–‡ä»¶ - priority_networks (ä¿®æ­£ä¸º22ä½æ©ç )
      lineinfile:
        path: "{{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/be/conf/be.conf"
        regexp: '^priority_networks\s*='
        line: "priority_networks = {{ new_network }}.0/22"
        backup: yes

# é˜¶æ®µ2: å¯åŠ¨æœåŠ¡ (ä¸¥æ ¼æŒ‰ç…§æ–‡æ¡£é¡ºåº)
- name: "é˜¶æ®µ2: å¯åŠ¨Master FEæœåŠ¡"
  hosts: doris-s12
  gather_facts: no
  tags: ["ip_migration"]
  tasks:
    - name: å¯åŠ¨Master FEèŠ‚ç‚¹
      shell: |
        cd {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/fe/bin
        ./start_fe.sh --daemon

    - name: ç­‰å¾…Master FEå¯åŠ¨
      wait_for:
        port: 9030
        host: "{{ new_network }}.112"
        state: started
        timeout: 180

    - name: éªŒè¯Master FEçŠ¶æ€
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "SHOW FRONTENDS;"
      register: master_status
      retries: 5
      delay: 10
      delegate_to: localhost

    - name: æ˜¾ç¤ºMasterçŠ¶æ€
      debug:
        var: master_status.stdout_lines

- name: "é˜¶æ®µ2: å¯åŠ¨å…¶ä»–FEæœåŠ¡"
  hosts: doris-s1,doris-s3,doris-s11,doris-s20
  gather_facts: no
  serial: 1
  tags: ["ip_migration"]
  vars:
    # æ–°IPæ˜ å°„
    new_ip_map:
      doris-s1: "{{ new_network }}.101"
      doris-s3: "{{ new_network }}.103"
      doris-s11: "{{ new_network }}.111"
      doris-s20: "{{ new_network }}.120"
  tasks:
    - name: å¯åŠ¨Follower FEèŠ‚ç‚¹
      shell: |
        cd {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/fe/bin
        ./start_fe.sh --helper {{ new_network }}.112:9010 --daemon

    - name: ç­‰å¾…FEèŠ‚ç‚¹å¯åŠ¨
      wait_for:
        port: 9030
        host: "{{ new_ip_map[inventory_hostname] }}"
        state: started
        timeout: 180

    - name: éªŒè¯FEèŠ‚ç‚¹çŠ¶æ€
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "SHOW FRONTENDS;" | grep {{ inventory_hostname }}
      register: fe_status
      retries: 5
      delay: 10
      delegate_to: localhost

    - name: æ˜¾ç¤ºFEèŠ‚ç‚¹çŠ¶æ€
      debug:
        msg: "{{ inventory_hostname }} ({{ new_ip_map[inventory_hostname] }}) çŠ¶æ€: {{ fe_status.stdout }}"

- name: "é˜¶æ®µ2: å¯åŠ¨BEæœåŠ¡"
  hosts: doris_be
  gather_facts: no
  serial: 5  # æ¯æ‰¹5ä¸ªèŠ‚ç‚¹
  tags: ["ip_migration"]
  vars:
    # å®Œæ•´çš„æ–°IPæ˜ å°„
    be_ip_map:
      doris-s1: "{{ new_network }}.101"
      doris-s2: "{{ new_network }}.102"
      doris-s3: "{{ new_network }}.103"
      doris-s4: "{{ new_network }}.104"
      doris-s5: "{{ new_network }}.105"
      doris-s6: "{{ new_network }}.106"
      doris-s7: "{{ new_network }}.107"
      doris-s8: "{{ new_network }}.108"
      doris-s9: "{{ new_network }}.109"
      doris-s10: "{{ new_network }}.110"
      doris-s11: "{{ new_network }}.111"
      doris-s12: "{{ new_network }}.112"
      doris-s13: "{{ new_network }}.113"
      doris-s14: "{{ new_network }}.114"
      doris-s15: "{{ new_network }}.115"
      doris-s16: "{{ new_network }}.116"
      doris-s17: "{{ new_network }}.117"
      doris-s18: "{{ new_network }}.118"
      doris-s19: "{{ new_network }}.119"
      doris-s20: "{{ new_network }}.120"
      doris-s21: "{{ new_network }}.121"
      doris-s22: "{{ new_network }}.122"
      doris-s23: "{{ new_network }}.123"
      doris-s24: "{{ new_network }}.124"
      doris-s25: "{{ new_network }}.125"
      doris-s26: "{{ new_network }}.126"
      doris-s27: "{{ new_network }}.127"
      doris-s28: "{{ new_network }}.128"
      doris-s29: "{{ new_network }}.129"
      doris-s30: "{{ new_network }}.130"
      doris-s31: "{{ new_network }}.131"
      doris-s32: "{{ new_network }}.132"
      doris-s33: "{{ new_network }}.133"
  tasks:
    - name: å¯åŠ¨BEæœåŠ¡
      shell: |
        cd {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/be/bin
        ./start_be.sh --daemon

    - name: ç­‰å¾…BEæœåŠ¡å¯åŠ¨
      wait_for:
        port: 9060
        host: "{{ be_ip_map[inventory_hostname] }}"
        state: started
        timeout: 180

    - name: æ£€æŸ¥BEå¥åº·çŠ¶æ€
      uri:
        url: "http://{{ be_ip_map[inventory_hostname] }}:8040/api/health"
        method: GET
        timeout: 10
      register: be_health
      ignore_errors: yes

    - name: æ˜¾ç¤ºBEå¥åº·çŠ¶æ€
      debug:
        msg: "BEèŠ‚ç‚¹ {{ inventory_hostname }} ({{ be_ip_map[inventory_hostname] }}) å¥åº·çŠ¶æ€: {{ 'OK' if be_health.status == 200 else 'FAILED' }}"

- name: "é˜¶æ®µ2: æ¢å¤ç®¡ç†æœåŠ¡"
  hosts: doris_cluster
  gather_facts: no
  tags: ["ip_migration"]
  tasks:
    - name: å¯åŠ¨Doris Manager
      shell: |
        cd /home/semptian/doris-manager/webserver/bin
        ./start.sh
      ignore_errors: yes
      when: inventory_hostname == "doris-s2"

    - name: é‡æ–°å¯åŠ¨Manager Agent (æ¸…ç†IDæ–‡ä»¶)
      shell: |
        cd /home/semptian/manager-agent/bin
        ./stop.sh 2>/dev/null || true
        rm -rf agent_id manager_id
        ./start.sh
      ignore_errors: yes

    - name: æ£€æŸ¥å¹¶æ¢å¤å¼€æœºè‡ªå¯åŠ¨
      shell: |
        for service in doris-be.service doris-fe.service; do
          if systemctl list-unit-files | grep -q "^$service"; then
            echo "å¯ç”¨æœåŠ¡: $service"
            systemctl unmask $service 2>/dev/null || true
            systemctl enable $service
          else
            echo "æœåŠ¡ä¸å­˜åœ¨ï¼Œè·³è¿‡: $service"
          fi
        done
      ignore_errors: yes

- name: "é˜¶æ®µ2: ç­‰å¾…é›†ç¾¤ç¨³å®šå¹¶å¼€å¯åˆ†ç‰‡å‡è¡¡"
  hosts: localhost
  gather_facts: yes
  tags: ["ip_migration"]
  tasks:
    - name: ç­‰å¾…é›†ç¾¤å®Œå…¨ç¨³å®š
      pause:
        seconds: 60
        prompt: "ç­‰å¾…Dorisé›†ç¾¤æœåŠ¡å®Œå…¨å¯åŠ¨å’Œç¨³å®š..."

    - name: éªŒè¯é›†ç¾¤çŠ¶æ€
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "
        SHOW FRONTENDS;
        SHOW BACKENDS;
        SHOW PROC '/backends';"
      register: cluster_status
      retries: 3
      delay: 10

    - name: æ˜¾ç¤ºé›†ç¾¤çŠ¶æ€
      debug:
        var: cluster_status.stdout_lines

    - name: æ£€æŸ¥æ‰€æœ‰BEèŠ‚ç‚¹æ˜¯å¦Alive
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "SHOW PROC '/backends';" | grep -c "true"
      register: alive_be_count

    - name: éªŒè¯BEèŠ‚ç‚¹æ•°é‡
      debug:
        msg: "å½“å‰Aliveçš„BEèŠ‚ç‚¹æ•°é‡: {{ alive_be_count.stdout }}/33"

    - name: å¼€å¯åˆ†ç‰‡å‡è¡¡åŠŸèƒ½
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "
        admin set frontend config('disable_balance' = 'false');
        admin set frontend config('disable_colocate_balance' = 'false');
        admin set frontend config('disable_tablet_scheduler' = 'false');"
      when: alive_be_count.stdout | int >= 30  # è‡³å°‘30ä¸ªBEèŠ‚ç‚¹æ­£å¸¸æ‰å¼€å¯å‡è¡¡

    - name: éªŒè¯åˆ†ç‰‡å‡è¡¡é…ç½®
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "
        admin show frontend config like '%balance%';
        admin show frontend config like '%scheduler%';"
      register: balance_config

    - name: æ˜¾ç¤ºåˆ†ç‰‡å‡è¡¡é…ç½®
      debug:
        var: balance_config.stdout_lines

- name: "é˜¶æ®µ2: æ•°æ®å®Œæ•´æ€§éªŒè¯"
  hosts: localhost
  gather_facts: yes
  tags: ["ip_migration", "verification"]
  tasks:
    - name: æ‰§è¡Œè¯»å†™æµ‹è¯•
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "
        CREATE DATABASE IF NOT EXISTS test_migration_{{ ansible_date_time.epoch }};
        USE test_migration_{{ ansible_date_time.epoch }};
        CREATE TABLE IF NOT EXISTS test_table (
          id BIGINT,
          name VARCHAR(64),
          ts DATETIME
        )
        ENGINE=OLAP
        DUPLICATE KEY(id)
        DISTRIBUTED BY HASH(id) BUCKETS 10
        PROPERTIES ('replication_num' = '1');

        INSERT INTO test_table VALUES
        (1, 'Migration Test', NOW()),
        (2, 'IP Change Test', NOW());

        SELECT COUNT(*) as test_count FROM test_table;

        DROP DATABASE test_migration_{{ ansible_date_time.epoch }};"
      register: rw_test_result
      ignore_errors: yes

    - name: æ˜¾ç¤ºè¯»å†™æµ‹è¯•ç»“æœ
      debug:
        msg: |
          è¯»å†™æµ‹è¯•ç»“æœ: {{ 'PASSED' if rw_test_result.rc == 0 else 'FAILED' }}
          {{ rw_test_result.stdout_lines if rw_test_result.rc == 0 else rw_test_result.stderr }}

    - name: å…ƒæ•°æ®æŸåæ£€æµ‹
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "
        SELECT COUNT(*) FROM information_schema.tables;
        SHOW PROC '/statistic';"
      register: metadata_check
      ignore_errors: yes

    - name: ä¿å­˜è¿ç§»åçŠ¶æ€
      shell: |
        mysql -h {{ new_network }}.112 -P 9030 -u root -p123456 -e "
        SHOW FRONTENDS;
        SHOW BACKENDS;
        SHOW PROC '/backends';
        SHOW PROC '/statistic';" > /tmp/doris_cluster_status_after_migration_{{ ansible_date_time.epoch }}.log

    - name: æ˜¾ç¤ºè¿ç§»å®Œæˆä¿¡æ¯
      debug:
        msg: |
          ========================================
          ğŸ‰ Dorisé›†ç¾¤IPè¿ç§»å®Œæˆï¼
          ========================================

          âœ… æ–°çš„è¿æ¥ä¿¡æ¯ï¼š
          - æ•°æ®åº“è¿æ¥: mysql -h {{ new_network }}.112 -P 9030 -u root -p123456
          - FEç®¡ç†ç•Œé¢: http://{{ new_network }}.101:8030
          - Doris Manager: http://{{ new_network }}.102:8004/1/monitor/dashboard
          - BEç®¡ç†ç•Œé¢: http://{{ new_network }}.101:8040

          ğŸ“Š é›†ç¾¤çŠ¶æ€ï¼š
          - è¯»å†™æµ‹è¯•: {{ 'PASSED' if rw_test_result.rc == 0 else 'FAILED' }}
          - Alive BEèŠ‚ç‚¹: {{ alive_be_count.stdout }}/33
          - åˆ†ç‰‡å‡è¡¡: {{ 'å·²å¼€å¯' if alive_be_count.stdout | int >= 30 else 'å¾…æ‰‹åŠ¨å¼€å¯' }}

          ğŸ“ çŠ¶æ€æ–‡ä»¶ï¼š
          - è¿ç§»åçŠ¶æ€: /tmp/doris_cluster_status_after_migration_{{ ansible_date_time.epoch }}.log

          âš ï¸  åç»­æ“ä½œï¼š
          1. æ›´æ–°å…¶ä»–ä¾èµ–æœåŠ¡çš„é…ç½®æ–‡ä»¶
          2. ç›‘æ§é›†ç¾¤çŠ¶æ€24-72å°æ—¶
          3. å¦‚æœ‰é—®é¢˜ï¼Œä½¿ç”¨å¤‡ä»½çš„å…ƒæ•°æ®å›æ»š

          ========================================

    - name: ç”Ÿæˆè¿ç§»æŠ¥å‘Š
      copy:
        content: |
          # Dorisé›†ç¾¤IPè¿ç§»æŠ¥å‘Š

          ## è¿ç§»ä¿¡æ¯
          - æ‰§è¡Œæ—¶é—´: {{ ansible_date_time.iso8601 }}
          - æ—§ç½‘æ®µ: 192.168.15.x
          - æ–°ç½‘æ®µ: {{ new_network }}.x

          ## è¿ç§»ç»“æœ
          - è¯»å†™æµ‹è¯•: {{ 'PASSED' if rw_test_result.rc == 0 else 'FAILED' }}
          - BEèŠ‚ç‚¹çŠ¶æ€: {{ alive_be_count.stdout }}/33 Alive
          - åˆ†ç‰‡å‡è¡¡: {{ 'å·²å¼€å¯' if alive_be_count.stdout | int >= 30 else 'éœ€æ‰‹åŠ¨å¼€å¯' }}

          ## æ–°çš„è®¿é—®åœ°å€
          - æ•°æ®åº“: mysql -h {{ new_network }}.112 -P 9030 -u root -p123456
          - FEç®¡ç†: http://{{ new_network }}.101:8030
          - Manager: http://{{ new_network }}.102:8004

          ## å¤‡ä»½æ–‡ä»¶ä½ç½®
          - FQDNæ”¹é€ å‰: /tmp/doris_cluster_status_before_fqdn_*.log
          - FQDNæ”¹é€ å: /tmp/doris_cluster_status_after_fqdn_*.log
          - IPè¿ç§»å‰: /tmp/doris_cluster_status_before_migration_*.log
          - IPè¿ç§»å: /tmp/doris_cluster_status_after_migration_*.log

          ## é…ç½®æ–‡ä»¶å¤‡ä»½
          - FEé…ç½®: {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/fe/conf/fe.conf-bak*
          - BEé…ç½®: {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/be/conf/be.conf-bak*
          - å…ƒæ•°æ®: {{ doris_home | default('/home/semptian/apache-doris-2.1.6-bin-x64') }}/fe/doris-meta-bak*
        dest: "/tmp/doris_migration_report_{{ ansible_date_time.epoch }}.md"
      delegate_to: localhost
